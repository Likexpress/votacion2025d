<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Elecciones Ciudadanas 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .form-wrapper {
      max-width: 950px;
      margin: auto;
      padding: 30px 20px;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
      border-top: 8px solid #d52b1e;
      border-bottom: 8px solid #007a33;
      padding: 30px;
      background-color: #fff;
    }
    h2 {
      font-weight: bold;
      color: #d52b1e;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-height: 90px;
    }
    .btn-success {
      background-color: #007a33;
      border: none;
    }
    .btn-success:hover {
      background-color: #005e28;
    }
    .form-label {
      font-weight: 600;
    }
    .section-title {
      margin-top: 30px;
      font-size: 1.2rem;
      color: #d52b1e;
      border-left: 5px solid #ffcc00;
      padding-left: 10px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="form-wrapper text-center">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo del proyecto" class="img-fluid">

    <h2>Votaciones Primarias Bolivia 2025</h2>
    <p class="text-muted">Participa en las votaciones primarias y elige al candidato de oposición que nos representará en las elecciones 2025.</p>

    <div class="card text-start">
      <form method="post" action="/enviar_voto" class="needs-validation" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="latitud" id="latitud">
        <input type="hidden" name="longitud" id="longitud">

        <!-- Género -->
        <div class="mb-3">
          <label class="form-label">Género</label>
          <select name="genero" class="form-select" required>
            <option value="">Selecciona tu género</option>
            <option value="Hombre">Hombre</option>
            <option value="Mujer">Mujer</option>
          </select>
        </div>

        <!-- Fecha de nacimiento -->
        <div class="mb-3">
          <label class="form-label">Fecha de nacimiento</label>
          <div class="row g-2">
            <div class="col">
              <select class="form-select" name="dia_nacimiento" required>
                <option value="">Día</option>
                {% for d in range(1, 32) %}
                  <option value="{{ d }}">{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <select class="form-select" name="mes_nacimiento" required>
                <option value="">Mes</option>
                {% for mes in ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] %}
                  <option value="{{ loop.index }}">{{ mes }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <select class="form-select" name="anio_nacimiento" required>
                <option value="">Año</option>
                {% for a in range(1920, 2010) %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Ubicación -->
        <div class="section-title">Datos de Ubicación</div>
        <div class="mb-3">
          <label class="form-label">País</label>
          <select id="pais" name="pais" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Departamento</label>
          <select id="departamento" name="departamento" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Provincia</label>
          <select id="provincia" name="provincia" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Municipio</label>
          <select id="municipio" name="municipio" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Recinto</label>
          <select id="recinto" name="recinto" class="form-select" required></select>
        </div>

        <!-- Preguntas de intención de voto -->
        <!-- === CSS específico (puede ir en <style> o tu CSS global) === -->
        <style>
          .candidate-grid { display:grid; gap:12px }
          @media (min-width:768px){ .candidate-grid{ grid-template-columns:1fr 1fr } }
          .candidate-card{
            position:relative; border:1.5px solid #e3e6ea; border-radius:12px;
            padding:14px 14px 14px 52px; background:#fff;
            box-shadow:0 1px 3px rgba(0,0,0,.04); cursor:pointer; min-height:88px
          }
          .candidate-card:hover{ border-color:#cbd3da }
          .candidate-card.selected{ border-color:#0d6efd; box-shadow:0 0 0 3px rgba(13,110,253,.15) }
          .candidate-radio{ position:absolute; left:14px; top:50%; transform:translateY(-50%); width:22px; height:22px }
          .party{ font-weight:700; font-size:.95rem; letter-spacing:.2px }
          .party.pdc{ color:#007a33 }     /* verde */
          .party.libre{ color:#d52b1e }   /* rojo  */
          /* Opciones no partidarias */
          .party.blanco{ color:#6c757d }  /* gris  */
          .party.nulo{ color:#343a40 }    /* gris oscuro */
          .party.indeciso{ color:#b08900 }/* dorado/aviso */
          .party.novota{ color:#0b5ed7 }  /* azul info */
          .pres{ margin:2px 0 0; font-weight:700 }
          .vice{ margin:0; color:#6c757d; font-size:.92rem }
          .note{ font-size:.9rem; color:#6c757d }
        </style>

        <!-- === Decisión Electoral (tarjetas con colores) === -->
        <div class="section-title">Decisión Electoral</div>
        <div class="mb-2">
          <label class="form-label">
            ¿Por quién votarás el <strong>domingo 19 de octubre</strong> en esta
            <strong>segunda vuelta</strong> de elecciones presidenciales?
          </label>
          <div class="note">Se vota por el <strong>Presidente</strong>. Se muestra el binomio para referencia.</div>
        </div>

        <div class="candidate-grid" id="candidatos">
          <!-- PDC -->
          <label class="candidate-card" for="cand-pdc">
            <input class="form-check-input candidate-radio" type="radio" id="cand-pdc"
                  name="candidato" value="Rodrigo Paz Pereyra" required>
            <div class="party pdc">PDC</div>
            <div class="pres">Rodrigo Paz Pereyra <small>(Presidente)</small></div>
            <p class="vice">Edman Lara <small>(Vicepresidente)</small></p>
          </label>

          <!-- LIBRE -->
          <label class="candidate-card" for="cand-libre">
            <input class="form-check-input candidate-radio" type="radio" id="cand-libre"
                  name="candidato" value="Jorge Tuto Quiroga" required>
            <div class="party libre">LIBRE</div>
            <div class="pres">Jorge “Tuto” Quiroga <small>(Presidente)</small></div>
            <p class="vice">Juan Pablo Velasco <small>(Vicepresidente)</small></p>
          </label>

          <!-- Voto en blanco -->
          <label class="candidate-card" for="cand-blanco">
            <input class="form-check-input candidate-radio" type="radio" id="cand-blanco"
                  name="candidato" value="Voto en blanco" required>
            <div class="party blanco">VOTO EN BLANCO</div>
            <div class="pres">No marcaré ninguna candidatura</div>
            <p class="vice">Boleta válida sin preferencia</p>
          </label>

          <!-- Voto nulo -->
          <label class="candidate-card" for="cand-nulo">
            <input class="form-check-input candidate-radio" type="radio" id="cand-nulo"
                  name="candidato" value="Voto nulo" required>
            <div class="party nulo">VOTO NULO</div>
            <div class="pres">Anularé mi voto</div>
            <p class="vice">Boleta inválida voluntariamente</p>
          </label>

          <!-- No sabe aún -->
          <label class="candidate-card" for="cand-indeciso">
            <input class="form-check-input candidate-radio" type="radio" id="cand-indeciso"
                  name="candidato" value="Aún no lo decidí" required>
            <div class="party indeciso">INDECISO/A</div>
            <div class="pres">Aún no lo decidí</div>
            <p class="vice">Necesito más información</p>
          </label>

          <!-- No va a votar -->
          <label class="candidate-card" for="cand-novota">
            <input class="form-check-input candidate-radio" type="radio" id="cand-novota"
                  name="candidato" value="No votaré" required>
            <div class="party novota">NO VOTARÉ</div>
            <div class="pres">No asistiré a votar</div>
            <p class="vice">Me ausentaré en esta elección</p>
          </label>
        </div>

        <!-- === JS mínimo para resaltar selección === -->
        <script>
          (function () {
            const grid = document.getElementById('candidatos');
            function paint() {
              grid.querySelectorAll('.candidate-card').forEach(card => {
                const r = card.querySelector('input[type="radio"]');
                card.classList.toggle('selected', r.checked);
              });
            }
            grid.addEventListener('change', paint);
            paint();
          })();
        </script>








        <div class="section-title">Compromiso con la Democracia</div>
        <div class="mb-3">
          <label class="form-label">¿Estás dispuesto(a) a colaborar en el control del voto con el proyecto <strong>CUIDEMOS EL VOTO</strong>?</label>
          <select id="pregunta3" name="pregunta3" class="form-select" required onchange="mostrarCampoCI(this)">
            <option value="">Selecciona una opción</option>
            <option value="Sí">Sí</option>
            <option value="No">No</option>
          </select>
        </div>
        <!-- Campo CI (condicional) -->
        <div class="mb-3 hidden" id="campo_ci">
          <label for="ci" class="form-label">Carnet de Identidad</label>
          <input type="number" id="ci" name="ci" class="form-control">
        </div>

        <!-- Botón de envío -->
        <div class="d-grid">
          <button type="submit" class="btn btn-success btn-lg">Enviar Voto</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let recintosData = [];

    async function cargarDatos() {
      const res = await fetch("/api/recintos");
      recintosData = await res.json();

      const paises = [...new Set(recintosData.map(r => r.nombre_pais))];
      paises.forEach(p => $('#pais').append(new Option(p, p)));
      $('#pais').val('Bolivia').trigger('change');
    }

    function actualizarDepartamentos() {
      const pais = $('#pais').val();
      const departamentos = [...new Set(recintosData.filter(r => r.nombre_pais === pais).map(r => r.nombre_departamento))];
      const select = $('#departamento');
      select.empty().append(new Option('Selecciona departamento', ''));
      departamentos.forEach(dep => select.append(new Option(dep, dep)));
      select.trigger('change');
    }

    function actualizarProvincias() {
      const pais = $('#pais').val();
      const departamento = $('#departamento').val();
      const provincias = [...new Set(recintosData.filter(r =>
        r.nombre_pais === pais && r.nombre_departamento === departamento).map(r => r.nombre_provincia))];
      const select = $('#provincia');
      select.empty().append(new Option('Selecciona provincia', ''));
      provincias.forEach(prov => select.append(new Option(prov, prov)));
      select.trigger('change');
    }

    function actualizarMunicipios() {
      const pais = $('#pais').val();
      const departamento = $('#departamento').val();
      const provincia = $('#provincia').val();
      const municipios = [...new Set(recintosData.filter(r =>
        r.nombre_pais === pais &&
        r.nombre_departamento === departamento &&
        r.nombre_provincia === provincia
      ).map(r => r.nombre_municipio))];
      const select = $('#municipio');
      select.empty().append(new Option('Selecciona municipio', ''));
      municipios.forEach(m => select.append(new Option(m, m)));
      select.trigger('change');
    }

    function actualizarRecintos() {
      const pais = $('#pais').val();
      const departamento = $('#departamento').val();
      const provincia = $('#provincia').val();
      const municipio = $('#municipio').val();
      const recintos = [...new Set(recintosData.filter(r =>
        r.nombre_pais === pais &&
        r.nombre_departamento === departamento &&
        r.nombre_provincia === provincia &&
        r.nombre_municipio === municipio
      ).map(r => r.nombre_recinto))];
      const select = $('#recinto');
      select.empty().append(new Option('Selecciona recinto', ''));
      recintos.forEach(r => select.append(new Option(r, r)));
      select.trigger('change');
    }

    function mostrarCampoCI(select) {
      const ciDiv = document.getElementById('campo_ci');
      const ciInput = document.getElementById('ci');
      if (select.value === 'Sí') {
        ciDiv.classList.remove('hidden');
        ciInput.required = true;
      } else {
        ciDiv.classList.add('hidden');
        ciInput.required = false;
      }
    }
    $(document).ready(() => {
      cargarDatos();
      $('#pais').select2().on('change', actualizarDepartamentos);
      $('#departamento').select2().on('change', actualizarProvincias);
      $('#provincia').select2().on('change', actualizarMunicipios);
      $('#municipio').select2().on('change', actualizarRecintos);
      $('#recinto').select2();
    });

    // Geolocalización al cargar
    window.onload = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            document.getElementById('latitud').value = pos.coords.latitude;
            document.getElementById('longitud').value = pos.coords.longitude;
          },
          function (error) {
            console.warn("No se pudo obtener la ubicación: " + error.message);
          },
          { timeout: 10000 }
        );
      } else {
        console.warn("Geolocalización no soportada.");
      }
    };

    // Evitar múltiples envíos del formulario
    document.querySelector('form').addEventListener('submit', function (e) {
      const boton = this.querySelector('button[type="submit"]');
      boton.disabled = true;
      boton.innerText = 'Enviando...';
    });
  </script>
</body>
</html>
