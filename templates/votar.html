<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Elecciones Ciudadanas 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    body { background-color: #f4f6f9; }
    .form-wrapper { max-width: 950px; margin: auto; padding: 20px; }
    .logo { max-width: 100px; display: block; margin: 0 auto 10px; }
    .subtitle { font-size: 1.1rem; color: #6c757d; }
    .card { border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.06); }
    .resumen { background-color: #fff; padding: 20px; margin-top: 25px; border-left: 4px solid #198754; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo">
    <h2 class="text-center">Votaciones Primarias Bolivia 2025</h2>
    <p class="text-center subtitle mb-4">Participa en las votaciones primarias y elige al candidato de oposición que nos representará en las elecciones 2025.</p>

    <div class="card p-4">
      <form method="post" action="/enviar_voto" class="needs-validation" novalidate>
        <input type="hidden" name="numero" value="{{ numero }}">

        <!-- CI -->
        <div class="mb-3">
          <label for="ci" class="form-label">Carnet de Identidad</label>
          <input type="number" id="ci" name="ci" class="form-control" required>
        </div>

        <!-- Fecha de nacimiento -->
        <div class="mb-3">
          <label class="form-label">Fecha de nacimiento</label>
          <div class="row g-2">
            <div class="col">
              <select class="form-select" name="dia_nacimiento" required>
                <option value="">Día</option>
                {% for d in range(1, 32) %}
                  <option value="{{ d }}">{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <select class="form-select" name="mes_nacimiento" required>
                <option value="">Mes</option>
                {% for mes in ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] %}
                  <option value="{{ loop.index }}">{{ mes }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <select class="form-select" name="anio_nacimiento" required>
                <option value="">Año</option>
                {% for a in range(1920, 2010) %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Cascada de ubicación -->
        <div class="mb-3">
          <label class="form-label">País</label>
          <select id="pais" name="pais" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Departamento</label>
          <select id="departamento" name="departamento" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Provincia</label>
          <select id="provincia" name="provincia" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Municipio</label>
          <select id="municipio" name="ciudad" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Recinto</label>
          <select id="recinto" name="recinto" class="form-select" required></select>
        </div>

        <!-- Candidato -->
        <div class="mb-3">
          <label class="form-label">Candidato</label>
          <select name="candidato" class="form-select" required>
            <option value="">Selecciona un candidato</option>
            {% for candidato in ['Jaime Dunn', 'Jorge Tuto Quiroga', 'Manfred Reyes Villa', 'Rodrigo Paz Pereira', 'Samuel Doria Medina'] %}
              <option value="{{ candidato }}">{{ candidato }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Enviar -->
        <div class="d-grid">
          <button type="submit" class="btn btn-success btn-lg">Enviar Voto</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let recintosData = [];

    async function cargarDatos() {
      const res = await fetch("/api/recintos");
      recintosData = await res.json();

      const paises = [...new Set(recintosData.map(r => r.nombre_pais))];
      paises.forEach(pais => $('#pais').append(new Option(pais, pais)));
      $('#pais').val('Bolivia').trigger('change');
    }

    function filtrarYActualizar(origenId, destinoId, campoPadre, campoHijo) {
      const seleccionado = $(`#${origenId}`).val();
      const opciones = recintosData
        .filter(r => r[campoPadre] === seleccionado)
        .map(r => r[campoHijo]);

      const unicos = [...new Set(opciones)];
      const select = $(`#${destinoId}`);
      select.empty().append(new Option(`Selecciona ${campoHijo}`, ''));
      unicos.forEach(op => select.append(new Option(op, op)));
      select.trigger('change');
    }

    $(document).ready(() => {
      cargarDatos();

      $('#pais').select2().on('change', () => {
        filtrarYActualizar('pais', 'departamento', 'nombre_pais', 'nombre_departamento');
      });

      $('#departamento').select2().on('change', () => {
        filtrarYActualizar('departamento', 'provincia', 'nombre_departamento', 'nombre_provincia');
      });

      $('#provincia').select2().on('change', () => {
        filtrarYActualizar('provincia', 'municipio', 'nombre_provincia', 'nombre_municipio');
      });

      $('#municipio').select2().on('change', () => {
        filtrarYActualizar('municipio', 'recinto', 'nombre_municipio', 'nombre_recinto');
      });

      $('#recinto').select2();
    });
  </script>
</body>
</html>
